# Design: ä½¿ç”¨è€…åŠŸèƒ½æ¬Šé™ç³»çµ±

## è³‡æ–™çµæ§‹

### users.preferences JSONB æ“´å……

```json
{
  "theme": "dark",
  "permissions": {
    "apps": {
      "terminal": false,
      "code-editor": false,
      "file-manager": true,
      "project-management": true,
      "ai-assistant": true,
      "prompt-editor": true,
      "agent-settings": true,
      "ai-log": true,
      "knowledge-base": true,
      "linebot": true,
      "settings": true
    },
    "knowledge": {
      "global_write": false,
      "global_delete": false
    }
  }
}
```

### æ¬Šé™æ¬„ä½èªªæ˜

- `permissions.apps.<app-id>`: æ˜¯å¦å¯ä½¿ç”¨è©²æ‡‰ç”¨ç¨‹å¼
- `permissions.knowledge.global_write`: æ˜¯å¦å¯ç·¨è¼¯å…¨åŸŸçŸ¥è­˜
- `permissions.knowledge.global_delete`: æ˜¯å¦å¯åˆªé™¤å…¨åŸŸçŸ¥è­˜

### çŸ¥è­˜åº«æ“´å……

çŸ¥è­˜æª”æ¡ˆ YAML Front Matter æ–°å¢ï¼š
```yaml
---
title: çŸ¥è­˜æ¨™é¡Œ
owner: username  # æ–°å¢ï¼šæ“æœ‰è€…ï¼ˆnull è¡¨ç¤ºå…¨åŸŸçŸ¥è­˜ï¼‰
scope: global    # æ–°å¢ï¼šglobal æˆ– personal
# ... å…¶ä»–ç¾æœ‰æ¬„ä½
---
```

## API è¨­è¨ˆ

### 1. å–å¾—ç›®å‰ä½¿ç”¨è€…æ¬Šé™

```
GET /api/user/me
```

å›æ‡‰åŒ…å«å®Œæ•´ permissionsï¼š
```json
{
  "id": 1,
  "username": "user1",
  "display_name": "User 1",
  "is_admin": false,
  "permissions": {
    "apps": { ... },
    "knowledge": { ... }
  }
}
```

### 2. å–å¾—ä½¿ç”¨è€…åˆ—è¡¨ï¼ˆç®¡ç†å“¡ï¼‰

```
GET /api/admin/users
Authorization: Bearer <admin_token>
```

å›æ‡‰ï¼š
```json
{
  "users": [
    {
      "id": 1,
      "username": "user1",
      "display_name": "User 1",
      "is_admin": false,
      "permissions": { ... },
      "last_login_at": "2024-12-24T10:00:00Z"
    }
  ]
}
```

### 3. æ›´æ–°ä½¿ç”¨è€…æ¬Šé™ï¼ˆç®¡ç†å“¡ï¼‰

```
PATCH /api/admin/users/{user_id}/permissions
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "apps": {
    "terminal": true,
    "code-editor": true
  },
  "knowledge": {
    "global_write": true
  }
}
```

åªå‚³å…¥è¦ä¿®æ”¹çš„æ¬„ä½ï¼Œå…¶ä»–ä¿æŒä¸è®Šã€‚

### 4. å–å¾—é è¨­æ¬Šé™è¨­å®š

```
GET /api/admin/default-permissions
Authorization: Bearer <admin_token>
```

å›æ‡‰ï¼š
```json
{
  "apps": {
    "terminal": false,
    "code-editor": false,
    "file-manager": true,
    ...
  },
  "knowledge": {
    "global_write": false,
    "global_delete": false
  }
}
```

## æ¬Šé™æª¢æŸ¥é‚è¼¯

### å¾Œç«¯æ¬Šé™æª¢æŸ¥

```python
# åˆ¤æ–·æ˜¯å¦ç‚ºç®¡ç†å“¡
def is_admin(username: str) -> bool:
    return username == settings.admin_username

# å–å¾—ä½¿ç”¨è€…æ¬Šé™ï¼ˆåˆä½µé è¨­å€¼ï¼‰
def get_user_permissions(user: User) -> dict:
    if is_admin(user.username):
        # ç®¡ç†å“¡æ“æœ‰æ‰€æœ‰æ¬Šé™
        return get_full_permissions()

    defaults = get_default_permissions()
    user_perms = user.preferences.get("permissions", {})
    return deep_merge(defaults, user_perms)

# æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ¬Šé™
def check_app_permission(user: User, app_id: str) -> bool:
    perms = get_user_permissions(user)
    return perms.get("apps", {}).get(app_id, True)

# æª¢æŸ¥çŸ¥è­˜åº«æ¬Šé™
def check_knowledge_permission(user: User, knowledge: Knowledge, action: str) -> bool:
    perms = get_user_permissions(user)

    # å€‹äººçŸ¥è­˜ï¼šæ“æœ‰è€…å®Œå…¨æ§åˆ¶
    if knowledge.owner == user.username:
        return True

    # å…¨åŸŸçŸ¥è­˜ï¼šä¾æ¬Šé™è¨­å®š
    if knowledge.scope == "global":
        if action == "read":
            return True
        elif action == "write":
            return perms.get("knowledge", {}).get("global_write", False)
        elif action == "delete":
            return perms.get("knowledge", {}).get("global_delete", False)

    return False
```

### å‰ç«¯æ¬Šé™æª¢æŸ¥

```javascript
// å„²å­˜æ–¼ window.currentUser
const currentUser = {
  username: "user1",
  is_admin: false,
  permissions: { ... }
};

// æª¢æŸ¥æ‡‰ç”¨ç¨‹å¼æ¬Šé™
function canAccessApp(appId) {
  if (currentUser.is_admin) return true;
  return currentUser.permissions?.apps?.[appId] ?? true;
}

// æ¡Œé¢åœ–ç¤ºéæ¿¾
function getVisibleApps() {
  return applications.filter(app => canAccessApp(app.id));
}
```

## é è¨­æ¬Šé™å¸¸æ•¸

```python
DEFAULT_PERMISSIONS = {
    "apps": {
        "file-manager": True,
        "terminal": False,        # é è¨­é—œé–‰
        "code-editor": False,     # é è¨­é—œé–‰
        "project-management": True,
        "ai-assistant": True,
        "prompt-editor": True,
        "agent-settings": True,
        "ai-log": True,
        "knowledge-base": True,
        "linebot": True,
        "settings": True,
    },
    "knowledge": {
        "global_write": False,    # é è¨­é—œé–‰
        "global_delete": False,   # é è¨­é—œé–‰
    }
}
```

## UI è¨­è¨ˆ

### ä½¿ç”¨è€…ç®¡ç†ä»‹é¢ï¼ˆç³»çµ±è¨­å®š â†’ ä½¿ç”¨è€…ç®¡ç†ï¼‰

åªæœ‰ç®¡ç†å“¡å¯è¦‹æ­¤åˆ†é ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä½¿ç”¨è€…ç®¡ç†                                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ æœå°‹ä½¿ç”¨è€…... [________]                                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ ä½¿ç”¨è€…    â”‚ é¡¯ç¤ºåç¨±    â”‚ æœ€å¾Œç™»å…¥       â”‚ æ“ä½œ           â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ yazelin  â”‚ ç®¡ç†å“¡      â”‚ 2024-12-24   â”‚ ğŸ”’ ç®¡ç†å“¡       â”‚ â”‚
â”‚ â”‚ â­       â”‚            â”‚ 10:00        â”‚                 â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ user1    â”‚ ä½¿ç”¨è€… 1    â”‚ 2024-12-23   â”‚ [è¨­å®šæ¬Šé™]      â”‚ â”‚
â”‚ â”‚          â”‚            â”‚ 15:30        â”‚                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¬Šé™è¨­å®šå°è©±æ¡†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¨­å®š user1 çš„æ¬Šé™                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                             â”‚
â”‚ æ‡‰ç”¨ç¨‹å¼æ¬Šé™                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [âœ“] æª”æ¡ˆç®¡ç†                             â”‚ â”‚
â”‚ â”‚ [ ] çµ‚ç«¯æ©Ÿ                               â”‚ â”‚
â”‚ â”‚ [ ] ç¨‹å¼ç·¨è¼¯å™¨                           â”‚ â”‚
â”‚ â”‚ [âœ“] å°ˆæ¡ˆç®¡ç†                             â”‚ â”‚
â”‚ â”‚ [âœ“] AI åŠ©æ‰‹                              â”‚ â”‚
â”‚ â”‚ [âœ“] Prompt ç·¨è¼¯å™¨                        â”‚ â”‚
â”‚ â”‚ [âœ“] Agent è¨­å®š                           â”‚ â”‚
â”‚ â”‚ [âœ“] AI Log                               â”‚ â”‚
â”‚ â”‚ [âœ“] çŸ¥è­˜åº«                               â”‚ â”‚
â”‚ â”‚ [âœ“] Line Bot                             â”‚ â”‚
â”‚ â”‚ [âœ“] ç³»çµ±è¨­å®š                             â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚ çŸ¥è­˜åº«æ¬Šé™                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ [ ] å¯ç·¨è¼¯å…¨åŸŸçŸ¥è­˜                        â”‚ â”‚
â”‚ â”‚ [ ] å¯åˆªé™¤å…¨åŸŸçŸ¥è­˜                        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                             â”‚
â”‚           [å–æ¶ˆ]  [å„²å­˜]                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¡Œé¢åœ–ç¤ºç„¡æ¬Šé™æç¤º

ç•¶ä½¿ç”¨è€…å˜—è©¦é–‹å•Ÿç„¡æ¬Šé™çš„æ‡‰ç”¨ç¨‹å¼ï¼š

```
Toast: ã€Œæ‚¨æ²’æœ‰ä½¿ç”¨çµ‚ç«¯æ©Ÿçš„æ¬Šé™ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ã€
```

æˆ–å®Œå…¨éš±è—ç„¡æ¬Šé™çš„åœ–ç¤ºï¼ˆå¾…ç¢ºèªå“ªç¨®æ–¹å¼è¼ƒå¥½ï¼‰ã€‚

## è³‡æ–™åº« Migration

```python
# 012_add_user_permissions.py

def upgrade():
    # ç‚ºç¾æœ‰ä½¿ç”¨è€…è¨­å®šé è¨­æ¬Šé™
    # ï¼ˆç”±æ–¼ä½¿ç”¨ JSONB åˆä½µé‚è¼¯ï¼Œå¯¦éš›ä¸Šä¸éœ€è¦ migrationï¼‰
    # åªéœ€ç¢ºä¿ç¨‹å¼ç¢¼æ­£ç¢ºè™•ç†ç©ºå€¼æƒ…æ³
    pass
```

ç”±æ–¼æ¬Šé™å„²å­˜åœ¨ç¾æœ‰çš„ `preferences` JSONB æ¬„ä½ï¼Œä¸”ç¨‹å¼ç¢¼æœƒè™•ç†ç¼ºå¤±å€¼ï¼Œ
ä¸éœ€è¦é¡å¤–çš„ migrationã€‚

## å®‰å…¨è€ƒé‡

1. ç®¡ç†å“¡ API éœ€æª¢æŸ¥ `is_admin` æ¬Šé™
2. æ¬Šé™æª¢æŸ¥éœ€åœ¨å¾Œç«¯åŸ·è¡Œï¼ˆå‰ç«¯æª¢æŸ¥åƒ…ç‚º UX å„ªåŒ–ï¼‰
3. ç®¡ç†å“¡å¸³è™Ÿä¸å¯è¢«å…¶ä»–ç®¡ç†å“¡ä¿®æ”¹æ¬Šé™
4. æ¬Šé™è®Šæ›´éœ€è¨˜éŒ„æ—¥èªŒï¼ˆå¯é¸ï¼Œå¾…å¾ŒçºŒå¯¦ä½œï¼‰
