# Proposal: 使用者功能權限系統

## 概述

新增使用者功能權限系統，讓管理員可以控制每個使用者能使用的功能。

## 目標

1. **應用程式權限**：控制使用者可開啟的桌面應用程式
2. **知識庫權限**：區分全域知識與個人知識的管理權限
3. **管理介面**：提供管理員設定使用者權限的介面

## 背景

目前 CTOS 系統所有功能對所有登入使用者開放，缺乏權限控管機制。
部分功能（如終端機、程式編輯器）具有較高風險，應預設關閉。
知識庫需區分全域知識（公司共用）與個人知識（私人筆記）。

## 設計決策

### 採用功能權限而非角色權限

使用者明確表示要用「功能權限」而非「角色權限」，因此：
- 每個使用者獨立設定各功能的權限
- 不使用預定義角色（如 admin、editor、viewer）
- 權限儲存在現有的 `users.preferences` JSONB 欄位

### 管理員識別

- 使用環境變數 `ADMIN_USERNAME` 指定管理員帳號
- 管理員擁有所有權限且無法被限制
- 管理員可以設定其他使用者的權限

### 預設權限

- 大部分功能預設開放
- **終端機**、**程式編輯器**預設關閉（安全考量）
- **全域知識管理**預設關閉（需管理員開放）

## 功能範圍

### 需要權限控制的應用程式（11 個）

| 應用程式 | ID | 預設 | 說明 |
|---------|-----|-----|------|
| 檔案管理 | file-manager | ✅ 開放 | 基本功能 |
| 終端機 | terminal | ❌ 關閉 | 高風險 |
| 程式編輯器 | code-editor | ❌ 關閉 | 高風險 |
| 專案管理 | project-management | ✅ 開放 | 基本功能 |
| AI 助手 | ai-assistant | ✅ 開放 | 核心功能 |
| Prompt 編輯器 | prompt-editor | ✅ 開放 | AI 相關 |
| Agent 設定 | agent-settings | ✅ 開放 | AI 相關 |
| AI Log | ai-log | ✅ 開放 | AI 相關 |
| 知識庫 | knowledge-base | ✅ 開放 | 核心功能 |
| Line Bot | linebot | ✅ 開放 | 溝通功能 |
| 系統設定 | settings | ✅ 開放 | 基本功能 |

### 知識庫特殊權限

| 權限 | 預設 | 說明 |
|-----|-----|------|
| 全域知識讀取 | ✅ 開放 | 所有人可讀 |
| 全域知識寫入 | ❌ 關閉 | 需權限才能編輯全域知識 |
| 全域知識刪除 | ❌ 關閉 | 需權限才能刪除全域知識 |
| 個人知識完整存取 | ✅ 開放 | 自己的知識完全控制 |

## 實作策略

1. **後端**：新增權限檢查 middleware、使用者權限 API
2. **前端**：桌面圖示依權限顯示/隱藏、新增使用者管理介面
3. **知識庫**：新增擁有者欄位、權限檢查

## 相關變更

- 修改 `backend-auth` spec（新增權限 API）
- 修改 `web-desktop` spec（權限控制 UI）
- 修改 `knowledge-base` spec（全域/個人知識區分）

## 影響評估

- 現有使用者不受影響（預設開放大部分功能）
- 管理員需要手動開放終端機/程式編輯器權限給需要的使用者
- 需要資料庫 migration 更新 users 表結構
