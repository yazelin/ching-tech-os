# Design: add-ai-tool-tracing

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Claude CLI                                     â”‚
â”‚        (--output-format stream-json --verbose)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      claude_agent.py                                  â”‚
â”‚  è§£æ stream-jsonï¼Œæå–ï¼š                                             â”‚
â”‚  - message: "æœ€çµ‚å›æ‡‰æ–‡å­—"                                            â”‚
â”‚  - tool_calls: [{name, input, output}, ...]                          â”‚
â”‚  - input_tokens, output_tokens                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚              â”‚              â”‚
                 â–¼              â–¼              â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Line Bot   â”‚  â”‚  Web Chat   â”‚  â”‚   AI Log    â”‚
        â”‚             â”‚  â”‚             â”‚  â”‚             â”‚
        â”‚ åªç”¨ messageâ”‚  â”‚ åªç”¨ messageâ”‚  â”‚ å­˜å®Œæ•´è³‡è¨Š  â”‚
        â”‚ âœ“ ä¸éœ€ä¿®æ”¹  â”‚  â”‚ âœ“ ä¸éœ€ä¿®æ”¹  â”‚  â”‚             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                         â”‚ AI Log å‰ç«¯ â”‚
                                         â”‚ é¡¯ç¤ºåŸ·è¡Œæµç¨‹â”‚
                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Claude CLI Stream-JSON è¼¸å‡ºæ ¼å¼

ä½¿ç”¨ `claude -p "prompt" --output-format stream-json --verbose` æ™‚ï¼Œè¼¸å‡ºç‚ºå¤šè¡Œ JSONï¼š

```json
{"type":"system","session_id":"...","tools":[...]}
{"type":"assistant","message":{"content":[{"type":"tool_use","id":"toolu_xxx","name":"query_project","input":{}}]}}
{"type":"user","message":{"content":[{"type":"tool_result","tool_use_id":"toolu_xxx","content":"{\"result\":\"...\"}"}]}}
{"type":"assistant","message":{"content":[{"type":"text","text":"æœ€çµ‚å›æ‡‰æ–‡å­—"}]}}
{"type":"result","result":"æœ€çµ‚å›æ‡‰æ–‡å­—","usage":{"input_tokens":100,"output_tokens":50}}
```

## è³‡æ–™çµæ§‹è¨­è¨ˆ

### ClaudeResponseï¼ˆä¿®æ”¹ï¼‰

```python
@dataclass
class ToolCall:
    """å·¥å…·èª¿ç”¨è¨˜éŒ„"""
    id: str                    # tool_use_id
    name: str                  # å·¥å…·åç¨±
    input: dict                # è¼¸å…¥åƒæ•¸
    output: str | None = None  # è¼¸å‡ºçµæœ

@dataclass
class ClaudeResponse:
    """Claude CLI å›æ‡‰"""
    success: bool
    message: str                              # æœ€çµ‚å›æ‡‰ï¼ˆçµ¦ Line Bot / Web Chat ç”¨ï¼‰
    error: str | None = None
    tool_calls: list[ToolCall] | None = None  # å·¥å…·èª¿ç”¨è¨˜éŒ„ï¼ˆçµ¦ AI Log ç”¨ï¼‰
    input_tokens: int | None = None
    output_tokens: int | None = None
```

### AI Log parsed_response æ ¼å¼

```json
{
  "tool_calls": [
    {
      "id": "toolu_xxx",
      "name": "mcp__ching-tech-os__query_project",
      "input": {},
      "output": "{\"result\": \"ç›®å‰æ²’æœ‰å°ˆæ¡ˆ\"}"
    },
    {
      "id": "toolu_yyy",
      "name": "mcp__ching-tech-os__search_knowledge",
      "input": {"query": "å°ˆæ¡ˆ"},
      "output": "{\"items\": [...]}"
    }
  ]
}
```

## å‰ç«¯åŸ·è¡Œæµç¨‹å€å¡Šè¨­è¨ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‹ åŸ·è¡Œæµç¨‹                                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â‘  ğŸ”§ mcp__ching-tech-os__query_project                    [â–¼]  â”‚
â”‚     â”Œâ”€ è¼¸å…¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ {}                                                    â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚     â”Œâ”€ è¼¸å‡º â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ {"result": "ç›®å‰æ²’æœ‰ä»»ä½•å°ˆæ¡ˆ"}                         â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â”‚  â‘¡ ğŸ”§ mcp__ching-tech-os__search_knowledge                 [â–¶]  â”‚
â”‚     (é»æ“Šå±•é–‹)                                                  â”‚
â”‚                                                                 â”‚
â”‚  â‘¢ ğŸ’¬ æœ€çµ‚å›æ‡‰                                                   â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚ ç›®å‰ç³»çµ±ä¸­æ²’æœ‰ä»»ä½•å°ˆæ¡ˆè³‡æ–™ã€‚                            â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### äº¤äº’è¨­è¨ˆ
- æ¯å€‹å·¥å…·èª¿ç”¨å€å¡Šå¯æ”¶åˆ/å±•é–‹
- é è¨­å±•é–‹ç¬¬ä¸€å€‹å·¥å…·èª¿ç”¨ï¼Œå…¶é¤˜æ”¶åˆ
- JSON å…§å®¹æ ¼å¼åŒ–é¡¯ç¤ºï¼ˆç¸®æ’ç¾åŒ–ï¼‰
- æœ€çµ‚å›æ‡‰æ°¸é å±•é–‹

## ä¿®æ”¹ç¯„åœ

| æª”æ¡ˆ | ä¿®æ”¹å…§å®¹ |
|------|----------|
| `backend/.../services/claude_agent.py` | ä½¿ç”¨ stream-jsonï¼Œè§£æä¸¦æå–å·¥å…·èª¿ç”¨ |
| `backend/.../api/ai.py` | è¨˜éŒ„ `parsed_response` å’Œ tokens åˆ° AI Log |
| `backend/.../services/linebot_agents.py` | åŒæ­¥ä¿®æ”¹èª¿ç”¨æ–¹å¼ï¼ˆå¦‚éœ€è¦ï¼‰ |
| `frontend/js/ai-log.js` | æ–°å¢ã€ŒåŸ·è¡Œæµç¨‹ã€å€å¡Šæ¸²æŸ“é‚è¼¯ |
| `frontend/css/ai-log.css` | åŸ·è¡Œæµç¨‹å€å¡Šæ¨£å¼ |

## å‘å¾Œç›¸å®¹æ€§

- **Line Bot**ï¼šåªä½¿ç”¨ `response.message`ï¼Œä¸å—å½±éŸ¿
- **Web Chat**ï¼šåªä½¿ç”¨ `response.message`ï¼Œä¸å—å½±éŸ¿
- **èˆŠ AI Log**ï¼š`parsed_response` ç‚º null æ™‚ï¼Œä¸é¡¯ç¤ºåŸ·è¡Œæµç¨‹å€å¡Š
