# 暫時性公開連結功能 - 技術設計

## 架構概覽

```
┌─────────────────────────────────────────────────────────────┐
│                     CTOS 主系統 (需登入)                     │
├─────────────────────────────────────────────────────────────┤
│  index.html                                                  │
│  ├── 知識庫 App（分享按鈕）                                   │
│  ├── 專案管理 App（分享按鈕）                                 │
│  └── 分享管理 App（管理所有連結）                             │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│               公開文件頁面 (獨立頁面，無需登入)               │
├─────────────────────────────────────────────────────────────┤
│  /s/{token} → public.html                                    │
│  ├── 完全獨立的頁面，不依賴 index.html 的 CSS/JS             │
│  ├── 類似線上文件檢視器的體驗                                 │
│  ├── 可瀏覽相關聯的知識庫                                     │
│  └── 支援下載、列印                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                       後端 API                               │
├─────────────────────────────────────────────────────────────┤
│  /api/share (需登入)          │  /api/public/{token} (無需登入)│
│  ├── POST 建立連結            │  └── GET 取得資源內容          │
│  ├── GET 列出我的連結          │                               │
│  └── DELETE 撤銷連結          │                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      資料庫                                  │
├─────────────────────────────────────────────────────────────┤
│  public_share_links                                          │
│  ├── id (UUID)                                              │
│  ├── token (VARCHAR 10, UNIQUE) ← 短 token 用於 URL          │
│  ├── resource_type (VARCHAR 20) ← 'knowledge' 或 'project'   │
│  ├── resource_id (VARCHAR 50)   ← kb-001 或專案 UUID         │
│  ├── created_by (VARCHAR 100)   ← 建立者使用者名稱            │
│  ├── expires_at (TIMESTAMPTZ)   ← 過期時間，NULL 表示永久     │
│  ├── access_count (INTEGER)     ← 存取次數統計               │
│  └── created_at (TIMESTAMPTZ)                                │
└─────────────────────────────────────────────────────────────┘
```

## Token 設計

### 格式
- 6 字元 Base62 編碼（a-z, A-Z, 0-9）
- 範例：`Ab3xK9`、`Zq7mN2`
- 共 62^6 ≈ 568 億種組合，足夠使用

### 產生方式
```python
import secrets
import string

def generate_token(length: int = 6) -> str:
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))
```

### 碰撞處理
- 產生 token 後檢查唯一性
- 若碰撞則重新產生（機率極低）

## API 設計

### 需登入的 API

#### POST /api/share
建立公開連結

請求：
```json
{
  "resource_type": "knowledge",
  "resource_id": "kb-001",
  "expires_in": "24h"  // 可選：1h, 24h, 7d, null（永久）
}
```

回應：
```json
{
  "token": "Ab3xK9",
  "url": "/s/Ab3xK9",
  "full_url": "https://ching-tech.ddns.net/ctos/s/Ab3xK9",
  "expires_at": "2024-01-07T14:30:00Z",
  "resource_type": "knowledge",
  "resource_id": "kb-001",
  "resource_title": "PLC 程式設計指南"
}
```

#### GET /api/share
列出我建立的連結

回應：
```json
{
  "links": [
    {
      "token": "Ab3xK9",
      "resource_type": "knowledge",
      "resource_id": "kb-001",
      "resource_title": "PLC 程式設計指南",
      "expires_at": "2024-01-07T14:30:00Z",
      "access_count": 5,
      "created_at": "2024-01-06T14:30:00Z",
      "is_expired": false
    }
  ]
}
```

#### DELETE /api/share/{token}
撤銷連結

### 無需登入的 API

#### GET /api/public/{token}
取得公開資源

回應（知識庫）：
```json
{
  "type": "knowledge",
  "data": {
    "id": "kb-001",
    "title": "PLC 程式設計指南",
    "content": "...",
    "attachments": [...],
    "created_at": "...",
    "updated_at": "..."
  },
  "shared_by": "ctlin",
  "shared_at": "2024-01-06T14:30:00Z"
}
```

回應（專案）：
```json
{
  "type": "project",
  "data": {
    "id": "uuid",
    "name": "專案名稱",
    "description": "...",
    "status": "active",
    "milestones": [...],
    "members": [...]  // 只顯示姓名和角色
  },
  "shared_by": "ctlin",
  "shared_at": "2024-01-06T14:30:00Z"
}
```

#### GET /api/public/{token}/attachments/{path}
取得公開資源的附件（無需登入）

## 公開文件頁面設計

### 設計理念
- **獨立頁面**：完全獨立於 CTOS 主系統，不依賴 index.html 的 CSS/JS
- **文件檢視器體驗**：類似線上閱讀文件的感覺，乾淨、專注於內容
- **可互動**：支援附件預覽、下載、列印
- **關聯瀏覽**：知識庫可顯示相關聯的知識，點擊可跳轉（若有公開連結）

### URL 路由
- `/s/{token}` → `public.html?t={token}`
- nginx 配置 rewrite 規則

### 頁面結構（知識庫）
```
┌─────────────────────────────────────────────────────────────┐
│  [Logo] 擎添工業                           [列印] [下載PDF] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                                                     │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ 文件標題                                       │ │   │
│  │  │ ─────────────────────────────────────────────  │ │   │
│  │  │ 分享者：ctlin ｜ 2024/01/06                    │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │                                               │ │   │
│  │  │  Markdown 內容渲染區                          │ │   │
│  │  │  （標題、段落、程式碼、表格等）               │ │   │
│  │  │                                               │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ 附件                                          │ │   │
│  │  │ ┌──────────┐ ┌──────────┐ ┌──────────┐       │ │   │
│  │  │ │ 📄 文件  │ │ 🖼 圖片  │ │ 📊 報表  │       │ │   │
│  │  │ │ spec.pdf │ │ demo.png │ │ data.csv │       │ │   │
│  │  │ │ [預覽]   │ │ [預覽]   │ │ [下載]   │       │ │   │
│  │  │ └──────────┘ └──────────┘ └──────────┘       │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  │  ┌───────────────────────────────────────────────┐ │   │
│  │  │ 相關知識                                       │ │   │
│  │  │ • PLC 程式設計入門                            │ │   │
│  │  │ • 變頻器調試指南                              │ │   │
│  │  └───────────────────────────────────────────────┘ │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  此內容由 擎添工業 分享 ｜ 連結有效至 2024/01/07 14:30      │
│  想了解更多？登入 CTOS 系統                                 │
└─────────────────────────────────────────────────────────────┘
```

### 頁面結構（專案）
```
┌─────────────────────────────────────────────────────────────┐
│  [Logo] 擎添工業                           [列印]           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  專案名稱                                            │   │
│  │  ─────────────────────────────────────────────────   │   │
│  │  狀態：進行中 ｜ 分享者：ctlin                        │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │                                                     │   │
│  │  專案描述                                            │   │
│  │  （Markdown 渲染）                                   │   │
│  │                                                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  里程碑                                              │   │
│  │  ────────────────────────────────────────           │   │
│  │  ✅ 設計完成     2024/01/05                         │   │
│  │  🔵 製造完成     預計 2024/02/15                    │   │
│  │  ⚪ 交機         預計 2024/03/01                    │   │
│  │                                                     │   │
│  ├─────────────────────────────────────────────────────┤   │
│  │  團隊成員                                            │   │
│  │  ────────────────────────────────────────           │   │
│  │  • 林小明 - 專案經理                                │   │
│  │  • 王大華 - 軟體工程師                              │   │
│  │  （聯絡資訊隱藏）                                    │   │
│  │                                                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  此內容由 擎添工業 分享 ｜ 連結有效至 2024/01/07 14:30      │
└─────────────────────────────────────────────────────────────┘
```

### 技術實作
- **獨立 CSS**：`public.css` 不引用 `main.css`，自帶完整樣式
- **獨立 JS**：`public.js` 不依賴其他模組
- **引入函式庫**：
  - marked.js（Markdown 渲染）
  - highlight.js（程式碼高亮）
  - qrcode.js（若需要顯示 QR Code）

### 功能
- 只讀 Markdown 渲染
- 附件預覽（圖片 lightbox、PDF 預覽）
- 附件下載
- 列印功能（優化列印樣式）
- 相關知識連結（若關聯知識也有公開連結）

### 錯誤處理
- 連結過期：顯示友善的「此連結已過期」頁面
- 連結不存在：顯示「連結不存在或已被撤銷」
- 資源被刪除：顯示「原始內容已被刪除」

---

## 分享管理應用程式設計

### 功能概述
一個獨立的桌面應用程式，用於管理所有分享連結。

### 介面佈局
```
┌─────────────────────────────────────────────────────────────┐
│  分享連結管理                                                │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 🔍 搜尋連結...          [全部 ▼] [狀態: 全部 ▼]     │   │
│  └─────────────────────────────────────────────────────┘   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📚 PLC 程式設計指南                          知識庫 │   │
│  │ /s/Ab3xK9 ｜ 有效至 2024/01/07 14:30                │   │
│  │ 瀏覽 5 次 ｜ 建立於 2024/01/06 14:30                │   │
│  │                              [複製連結] [🗑 刪除]   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📁 XX 廠房自動化專案                            專案 │   │
│  │ /s/Zq7mN2 ｜ 永久有效                               │   │
│  │ 瀏覽 12 次 ｜ 建立於 2024/01/05 10:00               │   │
│  │                              [複製連結] [🗑 刪除]   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 📚 變頻器調試手冊                            知識庫 │   │
│  │ /s/Xy4pQ1 ｜ ⚠️ 已過期 (2024/01/05 08:00)           │   │
│  │ 瀏覽 3 次 ｜ 建立於 2024/01/04 08:00                │   │
│  │                              [複製連結] [🗑 刪除]   │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 功能
- **列表顯示**：所有使用者建立的分享連結
- **過濾**：按資源類型（知識庫/專案）、狀態（有效/已過期）
- **搜尋**：按資源名稱搜尋
- **複製連結**：一鍵複製完整 URL
- **刪除連結**：即時刪除，確認後立即撤銷
- **狀態顯示**：明確標示有效/已過期

### 應用程式註冊
- 在 `desktop.js` 的 `applications` 新增 `share-manager`
- 圖示：🔗 或分享相關圖示
- 名稱：分享管理

---

## 分享對話框設計

### 觸發方式
- 知識庫：內容區右上角「分享」按鈕
- 專案管理：專案詳情區「分享」按鈕

### 對話框佈局（類似 Line 綁定碼彈窗）
```
┌─────────────────────────────────────────┐
│  分享「PLC 程式設計指南」          [✕]  │
├─────────────────────────────────────────┤
│                                         │
│  有效期限                               │
│  ┌─────────────────────────────────┐   │
│  │ ○ 1 小時                        │   │
│  │ ● 24 小時（推薦）               │   │
│  │ ○ 7 天                          │   │
│  │ ○ 永久有效                      │   │
│  └─────────────────────────────────┘   │
│                                         │
│           [產生分享連結]                │
│                                         │
│  ─────────────── 或 ───────────────    │
│                                         │
│  分享連結                               │
│  ┌─────────────────────────────────┐   │
│  │ https://xxx.ddns.net/ctos/s/Ab3 │   │
│  │                        [📋複製]  │   │
│  └─────────────────────────────────┘   │
│                                         │
│        ┌───────────────────┐           │
│        │                   │           │
│        │     [QR Code]     │           │
│        │                   │           │
│        └───────────────────┘           │
│                                         │
│  連結有效至 2024/01/07 14:30            │
│                                         │
└─────────────────────────────────────────┘
```

### 互動流程
1. 用戶點擊分享按鈕
2. 彈出對話框，選擇有效期（預設 24 小時）
3. 點擊「產生分享連結」
4. 顯示連結、QR Code
5. 用戶可複製連結或掃描 QR Code
6. 關閉對話框

## Line Bot MCP 工具

### create_share_link
```python
@mcp.tool()
async def create_share_link(
    resource_type: str,  # "knowledge" 或 "project"
    resource_id: str,    # kb-001 或專案 UUID
    expires_in: str = "24h"  # 1h, 24h, 7d, null
) -> str:
    """
    產生暫時性公開連結

    Args:
        resource_type: 資源類型（knowledge 或 project）
        resource_id: 資源 ID
        expires_in: 有效期（1h=1小時、24h=24小時、7d=7天、null=永久）

    Returns:
        公開連結的完整 URL
    """
```

### 使用情境
用戶：「這個知識太長了，給我一個連結我自己看」
AI：
1. 呼叫 `create_share_link(resource_type="knowledge", resource_id="kb-001")`
2. 回覆：「已產生公開連結，24 小時內有效：https://ching-tech.ddns.net/ctos/s/Ab3xK9」

## 安全考量

1. **Token 隨機性**：使用 `secrets` 模組產生加密安全的隨機 token
2. **過期機制**：預設 24 小時過期，減少長期暴露風險
3. **存取控制**：只有資源擁有者或有編輯權限的人可以建立連結
4. **資源權限**：個人知識只有擁有者可以分享
5. **刪除連動**：資源被刪除時，相關連結自動失效（API 回傳「已刪除」）

## 效能考量

1. **Token 索引**：`public_share_links.token` 建立唯一索引
2. **過期清理**：定期清理過期連結（可選，或靠查詢時過濾）
3. **存取計數**：異步更新避免阻塞主請求

## 子路徑部署相容

- 公開 API `/api/public/{token}` 會被 config.js 的 fetch 攔截正確處理
- 公開頁面 `/s/{token}` 需要 nginx rewrite 配合
- 產生連結時使用完整 URL 包含 base path
