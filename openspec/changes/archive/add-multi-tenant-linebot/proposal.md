# Change: 新增多租戶 Line Bot 架構

## Why

目前系統使用單一 Line Bot 服務所有租戶，造成以下問題：
1. 平台管理員需要手動指定群組歸屬哪個租戶
2. 所有公司看到同一個 Bot 名稱和頭像，無法客製化
3. 群組與租戶的關聯需要人工介入
4. **資料隔離風險**：不同租戶的資料可能混雜

需要讓每個租戶能使用自己的 Line Bot，或在共用 Bot 模式下確保資料隔離。

## 支援兩種模式

### 模式一：獨立 Bot（推薦，完全安全）
- 每個租戶設定自己的 Line Bot
- Webhook 簽名驗證自動識別租戶
- 群組自動歸屬，不可能混雜

### 模式二：共用 Bot（需指令綁定）
- 多個租戶共用預設 Bot
- 群組必須使用 `/綁定 公司代碼` 指令綁定
- 驗證發送者身份，防止跨租戶綁定

## What Changes

### 資料模型
- `TenantSettings` 新增 Line Bot 憑證欄位：
  - `line_channel_id`: Channel ID
  - `line_channel_secret`: Channel Secret（加密儲存）
  - `line_channel_access_token`: Access Token（加密儲存）
- 建立 migration 更新資料庫 schema

### Webhook 處理
- **BREAKING**: Webhook 驗證邏輯改為多租戶模式
- 收到請求時，遍歷所有租戶的 channel_secret 驗證簽名
- 驗證成功後自動識別租戶，不需人工指定
- 群組自動歸屬到對應租戶的 `tenant_id`

### 回覆訊息
- 使用對應租戶的 `access_token` 發送回覆
- 每個租戶的 Bot 獨立運作

### 管理介面
- 租戶管理介面新增「Line Bot 設定」區塊
- 租戶管理員可自行設定 Bot 憑證
- 平台管理員不再管理群組歸屬（自動化）

### Fallback 機制
- 若所有租戶 secret 都驗證失敗，使用環境變數的預設 Bot
- 預設 Bot 的群組歸屬到 `default` 租戶

## Impact

- Affected specs: `line-bot`
- Affected code:
  - `models/tenant.py` - 新增 Line Bot 設定欄位
  - `services/linebot.py` - 多租戶 webhook 驗證
  - `api/linebot_router.py` - webhook 處理邏輯
  - `frontend/js/tenant-admin.js` - Line Bot 設定 UI
- Migration: 需要建立 migration 新增欄位
- **BREAKING**: 現有單一 Bot 模式需要遷移到租戶設定

## 安全性分析

### 資料隔離保證

| 模式 | 安全等級 | 說明 |
|------|---------|------|
| 獨立 Bot | ⭐⭐⭐ 完全安全 | 簽名驗證決定租戶，不可能混雜 |
| 共用 Bot + 指令綁定 | ⭐⭐⭐ 安全 | 需驗證發送者身份，防止跨租戶綁定 |
| 共用 Bot + 自動綁定 | ⭐ 有風險 | 不採用，可能被「偷綁」 |

### 跨租戶綁定攻擊防護

**攻擊情境**：租戶 B 的用戶在租戶 A 的群組內，嘗試將群組綁定到租戶 B

**防護機制**：
1. `/綁定` 指令需驗證發送者是該租戶的已綁定用戶
2. 只有知道正確公司代碼且屬於該租戶的用戶才能綁定
3. 綁定後其他租戶用戶無法重新綁定（需先解綁）

## 決策

### 1. 憑證加密
**決定**：使用 AES-256 加密儲存

- Channel Secret 和 Access Token 加密後存入資料庫
- 加密金鑰從環境變數 `CREDENTIAL_ENCRYPTION_KEY` 讀取
- 使用時動態解密，不在記憶體中長期保存明文

### 2. 效能優化
**決定**：使用快取機制

- 租戶 Channel Secret 快取在記憶體中（TTL: 5 分鐘）
- 驗證簽名時從快取讀取，避免每次查詢資料庫
- 租戶更新 Bot 設定時清除快取

### 3. 遷移策略
**決定**：漸進式遷移

- 現有群組維持在 default 租戶，不強制遷移
- 新加入的群組依新機制自動歸屬
- 租戶管理員可在管理介面手動遷移群組

### 4. 解綁權限
**決定**：租戶管理員 + 平台管理員都可

- **租戶管理員**：可解綁自己租戶下的群組（用 `/解綁` 指令或管理介面）
- **平台管理員**：可解綁任何群組（用於處理錯誤綁定）
- 解綁後群組進入「未綁定」狀態，需重新綁定

## API 處理流程

### 獨立 Bot 模式

```
Line 請求 → Webhook 端點
    │
    ├─ 1. 從快取取得所有租戶的 channel_secret
    │
    ├─ 2. 遍歷驗證簽名
    │      ├─ 租戶 A secret → 驗證失敗
    │      ├─ 租戶 B secret → 驗證成功 ✓
    │      └─ 識別為租戶 B 的請求
    │
    ├─ 3. 群組自動歸屬租戶 B
    │
    └─ 4. 使用租戶 B 的 access_token 回覆
```

### 共用 Bot 模式

```
Line 請求 → Webhook 端點
    │
    ├─ 1. 用預設 channel_secret 驗證簽名
    │
    ├─ 2. 檢查群組是否已綁定租戶
    │      ├─ 已綁定 → 使用該租戶設定處理
    │      └─ 未綁定 → 檢查是否為 /綁定 指令
    │
    ├─ 3. 若為 /綁定 指令
    │      ├─ 驗證發送者身份
    │      ├─ 驗證公司代碼
    │      └─ 綁定群組到租戶
    │
    └─ 4. 使用預設 access_token 回覆
```

### 模式判斷優先順序

```
收到 Webhook 請求
    │
    ├─ 1. 先嘗試用各租戶 secret 驗證（獨立 Bot）
    │      └─ 成功 → 使用該租戶設定
    │
    └─ 2. 若全部失敗，用預設 secret 驗證（共用 Bot）
           ├─ 成功 → 檢查群組綁定狀態
           └─ 失敗 → 拒絕請求（400）
```
