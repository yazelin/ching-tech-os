# Line Bot æ•´åˆ

Line Bot æ•´åˆåŠŸèƒ½ï¼Œå¯¦ç¾ Line è¨Šæ¯å„²å­˜ã€AI åŠ©ç†å›æ‡‰ã€çŸ¥è­˜åº«ç®¡ç†èˆ‡å…¬é–‹åˆ†äº«ã€‚

## æ¶æ§‹

```
Line Platform
     â”‚
     â–¼ Webhook
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ linebot_    â”‚    â”‚ linebot_ai.py                           â”‚ â”‚
â”‚  â”‚ router.py   â”‚â”€â”€â”€â–¶â”‚ - process_message_with_ai               â”‚ â”‚
â”‚  â”‚ - webhook   â”‚    â”‚ - call_claude_with_tools                â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                          â”‚                             â”‚
â”‚         â–¼                          â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ linebot.py  â”‚    â”‚ mcp_server.py                           â”‚ â”‚
â”‚  â”‚ - å„²å­˜è¨Šæ¯  â”‚    â”‚ - å°ˆæ¡ˆï¼šquery/create/add_member/...     â”‚ â”‚
â”‚  â”‚ - ç”¨æˆ¶ç®¡ç†  â”‚    â”‚ - çŸ¥è­˜åº«ï¼šsearch/get/update/add_note/...â”‚ â”‚
â”‚  â”‚ - ç¾¤çµ„ç®¡ç†  â”‚    â”‚ - é™„ä»¶ï¼šadd/get/update_attachment       â”‚ â”‚
â”‚  â”‚ - æª”æ¡ˆå„²å­˜  â”‚    â”‚ - NASï¼šsearch_nas_files/prepare_file    â”‚ â”‚
â”‚  â”‚ - å›è¦†è¨Šæ¯  â”‚    â”‚ - åˆ†äº«ï¼šcreate_share_link               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚                                                        â”‚
â”‚         â–¼                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚  â”‚ PostgreSQL  â”‚    â”‚ NAS æª”æ¡ˆ    â”‚                             â”‚
â”‚  â”‚ line_*      â”‚    â”‚ é™„ä»¶å„²å­˜    â”‚                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## åŠŸèƒ½ç¸½è¦½

| åŠŸèƒ½ | èªªæ˜ |
|------|------|
| è¨Šæ¯å„²å­˜ | è‡ªå‹•å„²å­˜æ‰€æœ‰ç¾¤çµ„/å€‹äººè¨Šæ¯åˆ°è³‡æ–™åº« |
| æª”æ¡ˆå„²å­˜ | åœ–ç‰‡ã€æª”æ¡ˆè‡ªå‹•ä¸‹è¼‰åˆ° NAS |
| AI å°è©± | å€‹äºº/ç¾¤çµ„å°è©±æ”¯æ´ AI åŠ©ç† |
| AI åœ–ç‰‡ç”Ÿæˆ | æ ¹æ“šæ–‡å­—æè¿°ç”Ÿæˆåœ–ç‰‡ã€ç·¨è¼¯åœ–ç‰‡ |
| å°ˆæ¡ˆç®¡ç† | é€éå°è©±å»ºç«‹å°ˆæ¡ˆã€æ–°å¢æˆå“¡å’Œé‡Œç¨‹ç¢‘ |
| çŸ¥è­˜åº« | é€éå°è©±æ–°å¢ç­†è¨˜ã€æœå°‹çŸ¥è­˜ã€ç®¡ç†é™„ä»¶ |
| NAS æª”æ¡ˆæœå°‹ | æœå°‹ä¸¦ç™¼é€ NAS å…±äº«æª”æ¡ˆï¼ˆåœ–ç‰‡ç›´æ¥ç™¼é€ï¼‰ |
| å…¬é–‹åˆ†äº« | å»ºç«‹çŸ¥è­˜åº«/å°ˆæ¡ˆ/æª”æ¡ˆçš„å…¬é–‹é€£çµåˆ†äº«çµ¦å¤–éƒ¨äººå“¡ |

## è³‡æ–™è¡¨

### line_groups
ç¾¤çµ„è³‡è¨Šï¼Œå¯ç¶å®šå°ˆæ¡ˆã€‚

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | å…§éƒ¨ ID |
| line_group_id | VARCHAR(64) | Line ç¾¤çµ„ ID |
| name | VARCHAR(256) | ç¾¤çµ„åç¨± |
| project_id | UUID | ç¶å®šçš„å°ˆæ¡ˆ |
| is_active | BOOLEAN | æ˜¯å¦ä½¿ç”¨ä¸­ |

### line_users
ç”¨æˆ¶è³‡è¨Šã€‚

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | å…§éƒ¨ ID |
| line_user_id | VARCHAR(64) | Line ç”¨æˆ¶ ID |
| display_name | VARCHAR(256) | é¡¯ç¤ºåç¨± |
| user_id | INTEGER | å°æ‡‰çš„ç³»çµ±ç”¨æˆ¶ |

### line_messages
æ‰€æœ‰è¨Šæ¯è¨˜éŒ„ã€‚

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | å…§éƒ¨ ID |
| message_id | VARCHAR(64) | Line è¨Šæ¯ ID |
| line_user_id | UUID | ç™¼é€è€… |
| line_group_id | UUID | ç¾¤çµ„ï¼ˆNULL=å€‹äººï¼‰ |
| message_type | VARCHAR(32) | è¨Šæ¯é¡å‹ |
| content | TEXT | è¨Šæ¯å…§å®¹ |
| ai_processed | BOOLEAN | æ˜¯å¦å·² AI è™•ç† |

### line_files
æª”æ¡ˆè¨˜éŒ„ã€‚

| æ¬„ä½ | é¡å‹ | èªªæ˜ |
|------|------|------|
| id | UUID | å…§éƒ¨ ID |
| message_id | UUID | é—œè¯è¨Šæ¯ |
| file_type | VARCHAR(32) | æª”æ¡ˆé¡å‹ï¼ˆimage/file/video/audioï¼‰ |
| file_name | VARCHAR(256) | åŸå§‹æª”å |
| file_size | BIGINT | æª”æ¡ˆå¤§å° |
| nas_path | TEXT | NAS å„²å­˜è·¯å¾‘ |

## API ç«¯é»

### Webhook

```
POST /api/linebot/webhook
```

Line å¹³å°çš„ Webhook ç«¯é»ï¼Œéœ€åœ¨ Line Developers Console è¨­å®šã€‚

### ç¾¤çµ„ç®¡ç†

```
GET /api/linebot/groups
GET /api/linebot/groups/{group_id}
POST /api/linebot/groups/{group_id}/bind-project
DELETE /api/linebot/groups/{group_id}/bind-project
DELETE /api/linebot/groups/{group_id}
```

> **åˆªé™¤ç¾¤çµ„**ï¼šåˆªé™¤ç¾¤çµ„æœƒç´šè¯åˆªé™¤ç›¸é—œè¨Šæ¯ï¼ˆ`line_messages`ï¼‰å’Œæª”æ¡ˆè¨˜éŒ„ï¼ˆ`line_files`ï¼‰ï¼Œä½† NAS å¯¦é«”æª”æ¡ˆä¸æœƒè¢«åˆªé™¤ã€‚

### ç”¨æˆ¶ç®¡ç†

```
GET /api/linebot/users
GET /api/linebot/users/{user_id}
```

### è¨Šæ¯æŸ¥è©¢

```
GET /api/linebot/messages?group_id=xxx&page=1&page_size=50
```

## AI è™•ç†é‚è¼¯

### è§¸ç™¼æ¢ä»¶

- **å€‹äººå°è©±**ï¼šæ‰€æœ‰è¨Šæ¯éƒ½è§¸ç™¼ AI è™•ç†
- **ç¾¤çµ„å°è©±**ï¼šBot è¢« @ æåŠã€æˆ–å›è¦† Bot è¨Šæ¯æ™‚è§¸ç™¼

### Agent è¨­å®š

ç³»çµ±é è¨­å…©å€‹ Line Bot Agentï¼ˆå„²å­˜åœ¨ `ai_agents` è¡¨ï¼‰ï¼š

| Agent | æ¨¡å‹ | ç”¨é€” |
|-------|------|------|
| `linebot-personal` | claude-sonnet | å€‹äººå°è©±ï¼Œå®Œæ•´ prompt |
| `linebot-group` | claude-haiku | ç¾¤çµ„å°è©±ï¼Œç²¾ç°¡ prompt |

Prompt å…§å®¹å¯é€éã€ŒAI ç®¡ç†ã€æ‡‰ç”¨ç¨‹å¼ä¿®æ”¹ã€‚

### å°è©±æ­·å²

- æ¯å€‹ç”¨æˆ¶/ç¾¤çµ„ç¶­è­·ç¨ç«‹çš„å°è©±æ­·å²
- å°è©±æ­·å²å„²å­˜åœ¨ `ai_conversations` å’Œ `ai_conversation_messages` è¡¨
- ç”¨æˆ¶å¯ç™¼é€ `/æ–°å°è©±` æˆ– `/reset` æ¸…é™¤æ­·å²

### MCP å·¥å…·

AI åŠ©ç†å¯ä½¿ç”¨çš„å·¥å…·ï¼ˆå®Œæ•´åˆ—è¡¨è¦‹ [docs/mcp-server.md](mcp-server.md)ï¼‰ï¼š

**å°ˆæ¡ˆç®¡ç†**
- `query_project` - æŸ¥è©¢å°ˆæ¡ˆ
- `create_project` - å»ºç«‹å°ˆæ¡ˆ
- `add_project_member` - æ–°å¢æˆå“¡ï¼ˆis_internal é è¨­ Trueï¼Œå¤–éƒ¨äººå“¡è¨­ Falseï¼‰
- `add_project_milestone` - æ–°å¢é‡Œç¨‹ç¢‘
- `get_project_milestones` / `get_project_meetings` / `get_project_members` - æŸ¥è©¢

**çŸ¥è­˜åº«**
- `search_knowledge` - æœå°‹çŸ¥è­˜åº«
- `get_knowledge_item` - å–å¾—å®Œæ•´å…§å®¹
- `update_knowledge_item` - æ›´æ–°çŸ¥è­˜ï¼ˆå¯æ›´æ–°æ¨™é¡Œã€å…§å®¹ã€æ¨™ç±¤ã€é¡å‹ã€å±¤ç´šç­‰ï¼‰
- `delete_knowledge_item` - åˆªé™¤çŸ¥è­˜
- `add_note` - æ–°å¢ç´”æ–‡å­—ç­†è¨˜ï¼ˆè‡ªå‹•åˆ¤å®š scopeï¼‰
- `add_note_with_attachments` - æ–°å¢ç­†è¨˜ä¸¦åŠ å…¥é™„ä»¶ï¼ˆè‡ªå‹•åˆ¤å®š scopeï¼‰

> **çŸ¥è­˜åº« Scope è‡ªå‹•åˆ¤å®š**ï¼šé€é Line Bot å»ºç«‹çš„çŸ¥è­˜æœƒæ ¹æ“šå°è©±ä¾†æºè‡ªå‹•è¨­å®š scopeï¼š
> - **å€‹äººå°è©± + å·²ç¶å®š CTOS å¸³è™Ÿ** â†’ `personal`ï¼ˆåƒ…å»ºç«‹è€…å¯ç·¨è¼¯ï¼‰
> - **ç¾¤çµ„å°è©± + ç¾¤çµ„å·²ç¶å®šå°ˆæ¡ˆ** â†’ `project`ï¼ˆå°ˆæ¡ˆæˆå“¡å¯ç·¨è¼¯ï¼‰
> - **å…¶ä»–æƒ…æ³** â†’ `global`ï¼ˆå…¨åŸŸï¼Œåƒ… global_write æ¬Šé™å¯ç·¨è¼¯ï¼‰

**çŸ¥è­˜åº«é™„ä»¶**
- `get_message_attachments` - æŸ¥è©¢å°è©±ä¸­çš„é™„ä»¶ï¼ˆåœ–ç‰‡ã€æª”æ¡ˆï¼‰
- `add_attachments_to_knowledge` - ç‚ºç¾æœ‰çŸ¥è­˜æ–°å¢é™„ä»¶
- `get_knowledge_attachments` - æŸ¥è©¢çŸ¥è­˜åº«é™„ä»¶åˆ—è¡¨
- `update_knowledge_attachment` - æ›´æ–°é™„ä»¶èªªæ˜

**ç¾¤çµ„å°ˆç”¨**
- `summarize_chat` - å–å¾—ç¾¤çµ„èŠå¤©è¨˜éŒ„æ‘˜è¦

**NAS æª”æ¡ˆæœå°‹**
- `search_nas_files` - æœå°‹ NAS å…±äº«æª”æ¡ˆ
- `get_nas_file_info` - å–å¾—æª”æ¡ˆè©³ç´°è³‡è¨Š
- `prepare_file_message` - æº–å‚™æª”æ¡ˆè¨Šæ¯ä¾›å›è¦†

**åˆ†äº«åŠŸèƒ½**
- `create_share_link` - å»ºç«‹å…¬é–‹åˆ†äº«é€£çµï¼ˆæ”¯æ´çŸ¥è­˜åº«ã€å°ˆæ¡ˆã€NAS æª”æ¡ˆï¼‰

**AI åœ–ç‰‡ç”Ÿæˆ**ï¼ˆéœ€è¨­å®š nanobanana MCP Serverï¼‰
- `mcp__nanobanana__generate_image` - æ ¹æ“šæ–‡å­—æè¿°ç”Ÿæˆåœ–ç‰‡
- `mcp__nanobanana__edit_image` - ç·¨è¼¯/ä¿®æ”¹ç¾æœ‰åœ–ç‰‡

### ä½¿ç”¨æƒ…å¢ƒç¯„ä¾‹

**å»ºç«‹å°ˆæ¡ˆä¸¦æ–°å¢æˆå“¡**
```
ç”¨æˆ¶ï¼šå¹«æˆ‘å»ºç«‹ä¸€å€‹ã€Œæ°´åˆ‡çˆæ”¹å–„ã€å°ˆæ¡ˆï¼Œæˆå“¡æœ‰å¼µä¸‰å’Œæå››
AIï¼šï¼ˆä½¿ç”¨ create_project å»ºç«‹å°ˆæ¡ˆï¼‰
AIï¼šï¼ˆä½¿ç”¨ add_project_member æ–°å¢å¼µä¸‰ï¼‰
AIï¼šï¼ˆä½¿ç”¨ add_project_member æ–°å¢æå››ï¼‰
AIï¼šå·²å»ºç«‹å°ˆæ¡ˆã€Œæ°´åˆ‡çˆæ”¹å–„ã€ï¼Œä¸¦æ–°å¢æˆå“¡å¼µä¸‰ã€æå››
```

**å°‡å°è©±ä¸­çš„åœ–ç‰‡åŠ å…¥çŸ¥è­˜åº«**
```
ç”¨æˆ¶ï¼šæŠŠå‰›å‰›é‚£å¼µåœ–åŠ åˆ°çŸ¥è­˜åº«ï¼Œæ¨™é¡Œå«ã€Œæ°´åˆ‡çˆæ”¹å–„æ–¹æ¡ˆã€
AIï¼šï¼ˆä½¿ç”¨ get_message_attachments æŸ¥è©¢æœ€è¿‘çš„åœ–ç‰‡ï¼‰
AIï¼šï¼ˆä½¿ç”¨ add_note_with_attachments å»ºç«‹ç­†è¨˜ä¸¦åŠ å…¥åœ–ç‰‡ï¼‰
AIï¼šå·²å»ºç«‹çŸ¥è­˜ã€Œæ°´åˆ‡çˆæ”¹å–„æ–¹æ¡ˆã€ä¸¦åŠ å…¥ 1 å¼µåœ–ç‰‡
```

**å»ºç«‹åˆ†äº«é€£çµ**
```
ç”¨æˆ¶ï¼šå¹«æˆ‘åˆ†äº« kb-015 çµ¦å®¢æˆ¶çœ‹
AIï¼šï¼ˆä½¿ç”¨ create_share_link å»ºç«‹é€£çµï¼‰
AIï¼šåˆ†äº«é€£çµå·²å»ºç«‹ï¼
    é€£çµï¼šhttps://xxx/share/abc123
    æœ‰æ•ˆè‡³ 2026-01-07 19:00
```

**æœå°‹ä¸¦ç™¼é€ NAS æª”æ¡ˆ**
```
ç”¨æˆ¶ï¼šçµ¦æˆ‘äº¦é”çš„ layout åœ–
AIï¼šï¼ˆä½¿ç”¨ search_nas_files æœå°‹ï¼‰
AIï¼šï¼ˆæ‰¾åˆ°å¤šå€‹æª”æ¡ˆï¼Œåˆ—å‡ºä¾›ç”¨æˆ¶é¸æ“‡ï¼‰
ç”¨æˆ¶ï¼šç¬¬äºŒå€‹
AIï¼šï¼ˆä½¿ç”¨ prepare_file_message æº–å‚™æª”æ¡ˆï¼‰
AIï¼šï¼ˆç›´æ¥ç™¼é€åœ–ç‰‡åˆ° Lineï¼‰
```

**ç™¼é€å¤šå¼µåœ–ç‰‡**
```
ç”¨æˆ¶ï¼šçµ¦æˆ‘é‚£å€‹è³‡æ–™å¤¾çš„åœ–
AIï¼šï¼ˆæœå°‹æ‰¾åˆ° 10 å¼µåœ–ç‰‡ï¼‰
AIï¼šé€™å€‹è³‡æ–™å¤¾æœ‰ 10 å¼µåœ–ï¼Œæˆ‘å…ˆå‚³ 4 å¼µçµ¦ä½ çœ‹ï¼Œå…¶ä»–çš„é™„ä¸Šé€£çµï¼š
AIï¼šï¼ˆç™¼é€ 4 å¼µ ImageMessage + æ–‡å­—è¨Šæ¯å« 6 å€‹é€£çµï¼‰
```

**AI åœ–ç‰‡ç”Ÿæˆ**
```
ç”¨æˆ¶ï¼šç•«ä¸€éš»å¯æ„›çš„è²“
AIï¼šï¼ˆä½¿ç”¨ generate_image ç”Ÿæˆåœ–ç‰‡ï¼‰
AIï¼šï¼ˆä½¿ç”¨ prepare_file_message æº–å‚™ç™¼é€ï¼‰
AIï¼šå¥½çš„ï¼Œæˆ‘å¹«ä½ ç•«äº†ä¸€éš»è²“ ğŸ‘‡
AIï¼šï¼ˆé¡¯ç¤ºç”Ÿæˆçš„åœ–ç‰‡ï¼‰
```

**ç·¨è¼¯ AI ç”Ÿæˆçš„åœ–ç‰‡**
```
ç”¨æˆ¶ï¼šï¼ˆå›è¦† Bot ç™¼é€çš„åœ–ç‰‡ï¼‰æŠŠèƒŒæ™¯æ”¹æˆè—è‰²
AIï¼šï¼ˆæŸ¥è©¢ line_files å–å¾—åŸåœ–è·¯å¾‘ï¼‰
AIï¼šï¼ˆä½¿ç”¨ edit_image ç·¨è¼¯åœ–ç‰‡ï¼‰
AIï¼šå·²ä¿®æ”¹èƒŒæ™¯é¡è‰² ğŸ‘‡
AIï¼šï¼ˆé¡¯ç¤ºç·¨è¼¯å¾Œçš„åœ–ç‰‡ï¼‰
```

**ä»¥åœ–ç”Ÿåœ–**
```
ç”¨æˆ¶ï¼šï¼ˆå›è¦†ä¸€å¼µè‡ªå·±ä¸Šå‚³çš„åœ–ï¼‰ç•«é¡ä¼¼é¢¨æ ¼çš„ç‹—
AIï¼šï¼ˆå–å¾—ç”¨æˆ¶åœ–ç‰‡è·¯å¾‘ä½œç‚ºåƒè€ƒï¼‰
AIï¼šï¼ˆä½¿ç”¨ generate_image ç”Ÿæˆé¡ä¼¼é¢¨æ ¼çš„åœ–ï¼‰
AIï¼šåƒè€ƒä½ çš„åœ–ç‰‡é¢¨æ ¼ç•«äº†ä¸€éš»ç‹— ğŸ‘‡
```

## è¨­å®š

### ç’°å¢ƒè®Šæ•¸

```bash
# Line Bot è¨­å®š
CHING_TECH_LINE_CHANNEL_SECRET=your_channel_secret
CHING_TECH_LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token

# NAS è¨­å®šï¼ˆé™„ä»¶å„²å­˜ï¼‰
CHING_TECH_LINEBOT_NAS_HOST=192.168.1.xxx
CHING_TECH_LINEBOT_NAS_USER=username
CHING_TECH_LINEBOT_NAS_PASSWORD=password
CHING_TECH_LINEBOT_NAS_SHARE=share_name
CHING_TECH_LINEBOT_NAS_PATH=linebot/files
```

### Line Developers Console è¨­å®š

1. å»ºç«‹ Messaging API Channel
2. è¨­å®š Webhook URL: `https://your-domain/api/linebot/webhook`
3. å•Ÿç”¨ Webhook
4. å–å¾— Channel Secret å’Œ Channel Access Token

### AI åœ–ç‰‡ç”Ÿæˆè¨­å®š

éœ€è¦è¨­å®š nanobanana MCP Serverï¼ˆä½¿ç”¨ Google Gemini APIï¼‰ï¼š

1. åœ¨ `.mcp.json` åŠ å…¥è¨­å®šï¼ˆåƒè€ƒ `.mcp.json.example`ï¼‰ï¼š
```json
{
  "mcpServers": {
    "nanobanana": {
      "command": "npx",
      "args": ["-y", "@anthropics/create-mcp", "@willh/nano-banana-mcp"],
      "env": {
        "GOOGLE_GENERATIVE_AI_API_KEY": "your-gemini-api-key"
      }
    }
  }
}
```

2. ç³»çµ±æœƒè‡ªå‹•å»ºç«‹ symlink å°‡ç”Ÿæˆåœ–ç‰‡å­˜åˆ° NASï¼š
   - Symlink: `/tmp/ching-tech-os-cli/nanobanana-output`
   - ç›®æ¨™: `/mnt/nas/ctos/linebot/files/ai-images`

3. ç”Ÿæˆçš„åœ–ç‰‡æœƒè‡ªå‹•åœ¨ 1 å€‹æœˆå¾Œæ¸…ç†ï¼ˆæ’ç¨‹ä»»å‹™ï¼‰

## å‰ç«¯ä»‹é¢

æ¡Œé¢æ‡‰ç”¨ç¨‹å¼ã€ŒLine Botã€æä¾›ï¼š

- **ç¾¤çµ„æ¨™ç±¤é **ï¼šç¾¤çµ„åˆ—è¡¨ã€å°ˆæ¡ˆç¶å®šã€æœ€è¿‘è¨Šæ¯
- **ç”¨æˆ¶æ¨™ç±¤é **ï¼šç”¨æˆ¶åˆ—è¡¨ã€ç³»çµ±å¸³è™Ÿç¶å®š
- **è¨Šæ¯æ¨™ç±¤é **ï¼šè¨Šæ¯ç€è¦½ã€ç¾¤çµ„ç¯©é¸ã€é™„ä»¶é è¦½

## æª”æ¡ˆå„²å­˜

Line Bot æ”¶åˆ°çš„æª”æ¡ˆæœƒè‡ªå‹•ä¸‹è¼‰ä¸¦å„²å­˜åˆ° NASï¼š

```
NAS/{linebot_path}/
â”œâ”€â”€ {year}/
â”‚   â””â”€â”€ {month}/
â”‚       â”œâ”€â”€ {uuid}_image.jpg
â”‚       â”œâ”€â”€ {uuid}_document.pdf
â”‚       â””â”€â”€ ...
```

æª”æ¡ˆè·¯å¾‘è¨˜éŒ„åœ¨ `line_files.nas_path`ï¼Œå¯é€é `get_message_attachments` å·¥å…·æŸ¥è©¢ã€‚

## åŸ·è¡Œ Migration

```bash
cd backend
uv run alembic upgrade head
```

## Claude Code CLI æ•´åˆ

MCP Server ä½¿ç”¨ FastMCP å¯¦ä½œï¼Œæ”¯æ´ Claude Code CLI ä½¿ç”¨ã€‚è©³è¦‹ [docs/mcp-server.md](mcp-server.md)ã€‚

### è¨­å®šæ–¹å¼

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„çš„ `.mcp.json` åŠ å…¥ï¼ˆå·²è¨­å®šå®Œæˆï¼‰ï¼š

```json
{
  "mcpServers": {
    "ching-tech-os": {
      "command": "uv",
      "args": ["run", "python", "-m", "ching_tech_os.mcp_cli"],
      "cwd": "/home/ct/SDD/ching-tech-os/backend"
    }
  }
}
```

å•Ÿå‹• Claude Code CLI æ™‚æœƒè‡ªå‹•è¼‰å…¥å°ˆæ¡ˆçš„ MCP Serverã€‚
